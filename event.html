<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>숨은 에너지 찾기</title>
        <!-- Swiper CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
        <!-- 스타일 -->
        <link rel="stylesheet" href="style.css">
    </head>
<body>
<div id="page">
    <section class="layout-section">
        <div class="game-container">
            <div class="background">
                <span class="target item1" data-target="item1" data-text="전기차 배터리 셀(Battery Cell)" data-desc="더 빠르게 충전되고, 더 안전하며, 더 오래가는 '초고속 배터리' 2024 최고 혁신상 수상을 축하합니다"></span>
                <!-- <span class="target item2" data-target="item2" data-text="LNG(천연가스)선" data-desc="국내 최대 민간 LNG 사업자인 SK이노베이션은 개발부터 운송·소비까지 LNG 밸류체인을 구축하였습니다" ></span>
                <span class="target item3" data-target="item3" data-text="ZIC" data-desc="글로벌 No.1 윤활기유 '유베이스' 개발 및 이를 기반으로 한 고품질 엔진오일 ZIC를 생산하고 있습니다"></span>
                <span class="target item4" data-target="item4" data-text="슈퍼팔트" data-desc="SK에너지는 국내 최초로 고품질, 고기능성 아스팔트인 '슈퍼 팔트'를 개발하는 등 전 세계 아스팔트 시장 선도를 목표로 연구개발을 지속하고 있습니다"></span>
                <span class="target item5" data-target="item5" data-text="폴사인" data-desc="62년간 대한민국 에너지 역사와 함께해 온 SK이노베이션은 다가올 전동화 시대를 위해 '전기 밸류체인'을 구축하고 있습니다"></span>
                <span class="target item6" data-target="item6" data-text="해상광구" data-desc="호주 '탄소 저장' 탐사권 획득하여 '자원 개발·미래 에너지' 가속화에 동참합니다"></span>
                <span class="target item7" data-target="item7" data-text="SAF" data-desc="SK에너지, 국내 최초 지속가능 항공유 전용 생산라인을 확보하였습니다"></span>
                <span class="target item8" data-target="item8" data-text="EV" data-desc="SK배터리 아메리카 미국 공장, 현대차 탑재 배터리 양산을 시작합니다"></span>
                <span class="target item9" data-target="item9" data-text="ESS" data-desc="SK엔무브의 액침 냉각 기술을 적용한 '불타지 않는 ESS' 세계 최초 개발하였습니다"></span>
                <span class="target item10" data-target="item10" data-text="아이오딘" data-desc="SK엔무브, '차세대 차량용 냉매 핵심 원료' 아이오딘 안정적 공급망 확보에 힘쓰고 있습니다"></span> -->
            </div>
            <a href="/main.html" class="btn-home"><img src="/images/btn-home.png" alt="홈으로"></a>
            <div class="timer">00:00</div>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn">+</button>
                <button class="zoom-btn" id="zoomOut">-</button>
            </div>
            <div class="minimap">
                <div class="minimap-content">
                    <div class="minimap-viewport" />
                </div>
            </div>
        </div>

        <div class="target-info">
            <span class="bg-img"></span>
            <div class="text-box">
                <p><span class="name"></span></p>
                <p class="desc"></p>
            </div>
        </div>

        <div class="target-list">
            <p class="found-target">찾은 아이템 <strong class="found-count">0</strong>/10</p>
            <div class="swiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide" data-target="item1">1</div>
                    <!-- <div class="swiper-slide" data-target="item2">2</div>
                    <div class="swiper-slide" data-target="item3">3</div>
                    <div class="swiper-slide" data-target="item4">4</div>
                    <div class="swiper-slide" data-target="item5">5</div>
                    <div class="swiper-slide" data-target="item6">6</div>
                    <div class="swiper-slide" data-target="item7">7</div>
                    <div class="swiper-slide" data-target="item8">8</div>
                    <div class="swiper-slide" data-target="item9">9</div>
                    <div class="swiper-slide" data-target="item10">10</div> -->
                </div>
            </div>
        </div>
    </section>
</div>

<!-- 완료 레이어 -->
<div id="complete" class="complete-layer">
    <div class="complete-content">
        <a href="/main.html" class="btn-home2">
            <img src="/images/btn-home2.png" alt="홈으로" class="img">
            <span class="btn-home-text">돌아가기</span>
        </a>
        <div class="complete-top"><img src="/images/complete-top.png" alt="SK 에너지 찾기 성공. 추첨을 통해 1,500명에게 SK이노베이션 레고 블록팩을 드립니다!" class="img"></div>
        <div class="complete-text"><img src="/images/complete-text.png" alt="이벤트 참여를 위해 개인정보를 입력해주세요! 이름과 연락처는 랭킹화면에 공개되지 않습니다" class="img"></div>
        <div class="complete-form">
            <div class="form-item">
                <label for="name">이름</label>
                <input type="text" id="name" placeholder="이름">
            </div>
            <div class="form-item">
                <label for="phone1">연락처</label>
                <div class="phone-inputs">
                    <input type="text" id="phone1" maxlength="3" placeholder="010" oninput="this.value = this.value.replace(/[^0-9]/g, ''); autoNext(this, 3, 'phone2');">
                    <input type="text" id="phone2" maxlength="4" placeholder="0000" oninput="this.value = this.value.replace(/[^0-9]/g, ''); autoNext(this, 4, 'phone3');">
                    <input type="text" id="phone3" maxlength="4" placeholder="0000" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>
            </div>
            <p class="complete-tit">이벤트 유의사항</p>
            <ul class="complete-list">
                <li>입력한 이름과 연락처는 당첨자 발표 및 경품 지급에 사용되니, 정확히 확인후 입력해주세요.</li>
                <li>이벤트 당첨자에게는 추후 작성하신 연락처로 주소 입력 요청 문자를 발송할 예정입니다.</li>
            </ul>
            <p class="complete-tit mt-30">개인정보 처리방침</p>
            <div class="complete-privacy">
                SK에너지 이하 “본 법무법인”이라고 함은 『개인정보 보호법』 제30조에 따라 
                정보주체의 개인정보 및 권익을 보호하고 개인정보와 관련한 이용자의 고충을 원활하게
                 처리할 수 있도록 다음과 같은 개인정보 처리방침을 시행·준수하고 있습니다.
                제1조(처리하는 개인정보의 항목, 처리 목적, 처리 및 보유 기간)
                (1) 본 법무법인이 처리하는 개인정보의 항목, 개인정보의 처리 목적, 처리 및 
                보유 기간은 다음과 같습니다.
                가. 고객개인정보
            </div>
            <div class="complete-checkbox">
                <input type="checkbox" id="privacy" required>
                <label for="privacy">이벤트 참여를 위한 개인정보 수집활용</label>
            </div>
            <div class="complete-checkbox">
                <input type="checkbox" id="age" required>
                <label for="age">만 14세 이상입니다</label>
            </div>
            <button id="result"><img src="/images/btn-result.png" alt="결과보기" class="img"></button>
        </div>
    </div>
</div>

<!-- 닉네임 레이어 -->
<div id="nickname-layer" class="nickname-layer">
    <div class="nickname-content">
        <p>랭킹에 노출 될 닉네임을<br />입력해주세요.</p>
        <div class="mt-10">
            <input type="text" id="nicknameInput" placeholder="결과 랭킹에 노출됩니다!">
        </div>
        <p>닉네임은 추후 변경이 불가합니다.</p>
        <button id="submitNickname" class="btn-style mt-20">확인</button>
        <p class="nickname-error">이미 사용중인 닉네임 입니다.<br />다른 닉네임을 입력해주세요!</p>
    </div>
</div>

<!-- 결과보기 레이어 -->
<div id="result-layer" class="result-layer">
    <div class="result-content">
        <a href="/main.html" class="btn-home2">
            <img src="/images/btn-home2.png" alt="홈으로" class="img">
            <span class="btn-home-text">돌아가기</span>
        </a>
        <p class="result-tit">result</p>
        <p class="user">닉네임 님의 게임 결과</p>
        <p class="time">3분 20초</p>
        <p class="rank-text">나의 순위 : <span class="rank">2,233</span>위</p>
        <button class="btn-game-rank"><img class="img" src="/images/btn-today-rank.png" alt="오늘의 랭킹 확인"></button>
    </div>
    <div class="result-bottom">
        <button id="kakao-share-btn" class="btn-kakao-share mx-auto">카카오톡 공유하기</button>
        <a href="/main.html" class="btn-style">메인</a>
        <a href="/event.html" class="btn-style">다시도전</a>
    </div>
</div>

<!-- 오늘의 랭킹 레이어 -->
<div id="gameRankLayer" class="layer-popup">
    <div class="dimm"></div>
    <div class="content">
        <div class="my-rank-content">
            <h2>내 순위</h2>
            <p class="today-nickname"></p>
            <div>
                <p class="rank-text"><span class="today-rank">2,233</span>위</p>
                <p class="today-time"></p>
            </div>
        </div>
        <div class="today-rank-content">
            <h2>오늘의 랭킹</h2>
            <div class="rank-content">
                <ul class="rank-list">
                    <!-- 랭킹 데이터  -->
                </ul>
            </div>
            
            <button id="close-rank" type="button" class="btn-style">
                닫기
            </button>
        </div>
    </div>
</div>


<script src="js/common.js"></script>
<script src="js/game.js"></script>
<script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    // 완료 레이어 표시 함수(최종 플레이타임)
    function complete(finalTime) {
        const foundItems = document.querySelectorAll('.target.found').length;
        const totalItems = document.querySelectorAll('.target').length;
        if (foundItems < totalItems) {
            alert(`${totalItems}개의 아이템을 찾아주세요!`);
            return;
        }
        
        const completeLayer = document.getElementById('complete');
        completeLayer.classList.add('active');
        
        // 초 단위로 변환
        const [minutes, seconds] = finalTime.split(':').map(Number);
        const totalSeconds = minutes * 60 + seconds;
        
        document.getElementById('result').addEventListener('click', async function() {
            const name = document.getElementById('name').value;
            const phone1 = document.getElementById('phone1').value;
            const phone2 = document.getElementById('phone2').value;
            const phone3 = document.getElementById('phone3').value;
            const privacy = document.getElementById('privacy').checked;
            const age = document.getElementById('age').checked;
            const nickname = document.getElementById('nicknameInput').value;

            // 유효성 검사
            if (name.length < 2) {
                alert('이름을 2자 이상 입력해주세요.');
                return;
            }
            
            const phone = `${phone1}${phone2}${phone3}`;
            if (phone.length < 11) {
                alert('올바른 연락처를 입력해주세요.');
                return;
            }
            
            if (!privacy) {
                alert('개인정보 수집 활용에 동의해주세요.');
                return;
            }
            try {
                //const result = {result:true, nickname:'아무개', ranking:'2,233'};
                const response = await fetch('https://{DOMAIN}/api/event-proc.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        hphone: phone,
                        timer: finalTime,
                        agree1: privacy ? 'Y' : 'N',
                        agree2: age ? 'Y' : 'N',
                        ...(nickname && { nickname })
                    })
                });
                
                const result = await response.json();
                
                if (!result.result) {
                    if (result.message) {
                        alert(result.message);
                    } else {
                        alert('이벤트 참여 중 오류가 발생했습니다.');
                    }
                    return;
                }
                
                //닉네임이 없는 경우
                if (!result.nickname) {
                    openNicknameLayer();
                    return;
                }
                
                //닉네임이 있는 경우 결과 표시
                if (result.ranking) {
                    const resultLayer = document.getElementById('result-layer');
                    const user = resultLayer.querySelector('.user');
                    const time = resultLayer.querySelector('.time');
                    const rank = resultLayer.querySelector('.rank');
                    const gameRankLayer = document.getElementById('gameRankLayer');
                    const todayNickname= gameRankLayer.querySelector('.today-nickname');
                    const todayRank = gameRankLayer.querySelector('.today-rank');
                    const todayTime = gameRankLayer.querySelector('.today-time');

                    //데이터 세팅
                    user.textContent = `${result.nickname}님의 게임결과`;
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    time.textContent = `${minutes} : ${seconds}`;
                    rank.textContent = result.ranking.toLocaleString();

                    // 결과 레이어 표시
                    resultLayer.classList.add('active');

                    // 오늘의 랭킹 클릭 시 호출되는 팝업에 데이터 추가 셋팅
                    todayNickname.textContent = result.nickname;
                    todayTime.textContent = finalTime;
                    todayRank.textContent = result.ranking.toLocaleString();
                }
                
            } catch (error) {
                console.error('API 호출 중 오류 발생:', error);
                alert('이벤트 참여 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        });
    }

    // 닉네임 입력 레이어 OPEN
    function openNicknameLayer() {
        const nicknameLayer = document.getElementById('nickname-layer');
        nicknameLayer.classList.add('active');
    }
    // 닉네임 입력 레이어 CLOSE
    function closeNicknameLayer() {
        const nicknameLayer = document.getElementById('nickname-layer');
        nicknameLayer.classList.remove('active');
    }

    // 자동 다음 입력창 이동 함수
    function autoNext(currentInput, maxLength, nextInputId) {
        if (currentInput.value.length >= maxLength) {
            document.getElementById(nextInputId).focus();
        }
    }

    // 테스트용 랭킹 데이터
    const mockRankData = [
        { nickname: "에너지왕123", timer: 65.22 },
        { nickname: "찾아라SK", timer: 82.22 },
        { nickname: "게임고수", timer: 95.22 },
        { nickname: "SK매니아", timer: 110.22 },
        { nickname: "열심히찾기", timer: 125.22 },
        { nickname: "숨은보물", timer: 138.22 },
        { nickname: "에너지파인더", timer: 145.22 },
        { nickname: "SK러버", timer: 160.22 },
        { nickname: "파워레인저", timer: 180.22 }
    ];
    
    // DOM 로드
    document.addEventListener('DOMContentLoaded', function() {
        // 닉네임 저장 버튼 이벤트
        document.getElementById('submitNickname').addEventListener('click', async () => {
            const nickname = document.getElementById('nicknameInput').value;
            const name = document.getElementById('name').value;
            const phone1 = document.getElementById('phone1').value;
            const phone2 = document.getElementById('phone2').value;
            const phone3 = document.getElementById('phone3').value;
            const phone = `${phone1}${phone2}${phone3}`;
            
            //에러 메시지 숨기기
            const errorElement = document.querySelector('.nickname-error');
            errorElement.style.display = 'none';

            // 유효성 검사
            if (nickname.length < 2) {
                alert('닉네임을 2자 이상 입력해주세요.');
                return;
            }

            try {
                const response = await fetch('https://{DOMAIN}/api/nickname-proc.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        hphone: phone,
                        nickname: nickname
                    })
                });
                
                const result = await response.json();
                if (result.result) {
                    alert('닉네임이 저장되었습니다. 결과보기 버튼을 클릭해주세요.');
                    // 닉네임 레이어 닫기
                    closeNicknameLayer();
                } else {
                    // 실패 시 닉네임 중복 알림 노출
                    errorElement.style.display = 'block';
                }
            } catch (error) {
                console.error('닉네임 저장 중 오류 발생:', error);
                alert('닉네임 저장에 실패했습니다. 다시 시도해주세요.');
            }
        });

        //오늘의 랭킹 버튼 클릭
        document.querySelector('.btn-game-rank').addEventListener('click', function() {
            const rankList = document.querySelector('.rank-list');
            rankList.innerHTML = ''; // 기존 데이터 초기화
            openModal('gameRankLayer');

            // 테스트용 데이터 사용
            mockRankData.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="rank-num">${index + 1}</span>
                    <span class="rank-name">${item.nickname}</span>
                    <span class="rank-score">${item.timer}초</span>
                `;
                rankList.appendChild(li);
            });

            /* API 연동 예시
            fetch(`https://{DOMAIN}/api/rank`)
                .then(response => response.json())
                .then(data => {
                    data.slice(0, 9).forEach((item, index) => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span class="rank-num">${index + 1}</span>
                            <span class="rank-name">${item.nickname}</span>
                            <span class="rank-score">${item.timer}초</span>
                        `;
                        rankList.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('랭킹 데이터 로딩 실패:', error);
                });
            */
        });
    
        //카카오 초기화
        Kakao.init('a7fc4bbe5d956fcc2525283cd9daae87'); //key 변경 요망

        // 카카오 공유하기
        document.getElementById('kakao-share-btn').addEventListener('click', function() {
            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'SK찾아 세계속으로',
                    description: '전 세계 속 SK의 숨은 에너지 10개 찾고 레고 블록팩 받자!',
                    imageUrl: `${window.location.href}/images/background.jpg`,
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href,
                    },
                },
                buttons: [
                    {
                        title: '게임 시작하기',
                        link: {
                            mobileWebUrl: window.location.href,
                            webUrl: window.location.href,
                        },
                    },
                ],
            });
        });
    });

</script>
</body>
</html>