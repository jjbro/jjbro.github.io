<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>숨은 에너지 찾기</title>
        <!-- Swiper CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
        <!-- 스타일 -->
        <link rel="stylesheet" href="style.css">
    </head>
<body>
<div id="page">
    <section class="layout-section">
        <div class="game-container">
            <div class="background">
                <span class="target item1" data-text="모자"></span>
                <span class="target item2" data-text="우산"></span>
                <span class="target item3" data-text="시계"></span>
                <span class="target item4" data-text="책"></span>
                <span class="target item5" data-text="안경"></span>
                <span class="target item6" data-text="가방"></span>
                <span class="target item7" data-text="신발"></span>
                <span class="target item8" data-text="장갑"></span>
                <span class="target item9" data-text="지갑"></span>
                <span class="target item10" data-text="열쇠"></span>
            </div>
            <div class="timer">00:00</div>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomOut">-</button>
                <button class="zoom-btn" id="zoomIn">+</button>
            </div>
            <div class="minimap">
                <div class="minimap-content">
                    <div class="minimap-viewport"></div>
                </div>
            </div>
        </div>

        <div class="target-info">
            <div class="item">
            </div>
        </div>

        <div class="target-list">
            <p class="found-target">찾은 아이템 <strong class="found-count">0</strong>/10</p>
            <div class="swiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide" data-target="item1">모자</div>
                    <div class="swiper-slide" data-target="item2">우산</div>
                    <div class="swiper-slide" data-target="item3">시계</div>
                    <div class="swiper-slide" data-target="item4">책</div>
                    <div class="swiper-slide" data-target="item5">안경</div>
                    <div class="swiper-slide" data-target="item6">가방</div>
                    <div class="swiper-slide" data-target="item7">신발</div>
                    <div class="swiper-slide" data-target="item8">장갑</div>
                    <div class="swiper-slide" data-target="item9">지갑</div>
                    <div class="swiper-slide" data-target="item10">열쇠</div>
                </div>
            </div>
        </div>
    </section>
</div>
<div id="complete" class="complete-layer">
    <input type="text" id="name" placeholder="이름">
    <div class="phone-inputs">
        <input type="text" id="phone1" maxlength="3" placeholder="010" oninput="this.value = this.value.replace(/[^0-9]/g, ''); autoNext(this, 3, 'phone2');">
        <input type="text" id="phone2" maxlength="4" placeholder="0000" oninput="this.value = this.value.replace(/[^0-9]/g, ''); autoNext(this, 4, 'phone3');">
        <input type="text" id="phone3" maxlength="4" placeholder="0000" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
    </div>
    <div class="checkbox-group">
        <input type="checkbox" id="privacy" required>
        <label for="privacy">이벤트 참여를 위한 개인정보 수집활용</label>
    </div>
    <div class="checkbox-group">
        <input type="checkbox" id="age" required>
        <label for="age">만 14세 이상입니다</label>
    </div>
    <button id="result">결과보기</button>
</div>

<div id="nickname" class="nickname-layer">
    <div class="nickname-content">
        <input type="text" id="nicknameInput" placeholder="닉네임을 입력해주세요">
        <button id="submitNickname">확인</button>
    </div>
</div>

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="js/common.js"></script>
<script src="js/game.js"></script>
<script>

    // 완료 레이어 표시 함수(최종 플레이타임)
    function complete(finalTime) {
        const completeLayer = document.getElementById('complete');
        completeLayer.classList.add('active');
        
        // 초 단위로 변환
        const [minutes, seconds] = finalTime.split(':').map(Number);
        const totalSeconds = minutes * 60 + seconds;
        
        document.getElementById('result').addEventListener('click', async function() {
            const name = document.getElementById('name').value;
            const phone1 = document.getElementById('phone1').value;
            const phone2 = document.getElementById('phone2').value;
            const phone3 = document.getElementById('phone3').value;
            const privacy = document.getElementById('privacy').checked;
            const age = document.getElementById('age').checked;
            
            // 유효성 검사
            if (name.length < 2) {
                alert('이름을 2자 이상 입력해주세요.');
                return;
            }
            
            const phone = `${phone1}${phone2}${phone3}`;
            if (phone.length < 11) {
                alert('올바른 연락처를 입력해주세요.');
                return;
            }
            
            if (!privacy || !age) {
                alert('필수 약관에 동의해주세요.');
                return;
            }
            showNicknameLayer();
            try {
                const response = await fetch('https://{DOMAIN}/api/event-proc.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        hphone: phone,
                        timer: totalSeconds,
                        agree1: privacy ? 'Y' : 'N',
                        agree2: age ? 'Y' : 'N'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API 호출 실패');
                }
                
                const result = await response.json();
                
                if (!result.result) {
                    // 실패 시
                    if (result.message) {
                        alert(result.message);
                    } else {
                        alert('이벤트 참여 중 오류가 발생했습니다.');
                    }
                    return;
                }
                
                // 성공 시
                let successMessage = '이벤트 참여가 완료되었습니다!';
                if (result.ranking) {
                    successMessage += `\n오늘의 순위: ${result.ranking}위`;
                }
                
                // 닉네임 입력이 필요한 경우
                if (!result.nickname) {
                    showNicknameLayer();
                } else {
                    alert(successMessage);
                    completeLayer.classList.remove('active');
                }
                
            } catch (error) {
                console.error('API 호출 중 오류 발생:', error);
                alert('이벤트 참여 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        });
    }

    // 닉네임 입력 레이어 표시 함수
    function showNicknameLayer() {
        const completeLayer = document.getElementById('complete');
        const nicknameLayer = document.getElementById('nickname');
        const name = document.getElementById('name').value;
        const phone1 = document.getElementById('phone1').value;
        const phone2 = document.getElementById('phone2').value;
        const phone3 = document.getElementById('phone3').value;
        const phone = `${phone1}${phone2}${phone3}`;
        
        nicknameLayer.classList.add('active');
        
        document.getElementById('submitNickname').addEventListener('click', async () => {
            const nickname = document.getElementById('nicknameInput').value;
            if (nickname.length < 2) {
                alert('닉네임을 2자 이상 입력해주세요.');
                return;
            }
            
            try {
                const response = await fetch('https://{DOMAIN}/api/nickname-proc.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        hphone: phone,
                        nickname: nickname
                    })
                });
                
                if (!response.ok) {
                    throw new Error('닉네임 저장 실패');
                }
                
                const result = await response.json();
                if (result.result) {
                    // 성공 시
                    nicknameLayer.classList.remove('active');
                    alert('닉네임이 저장되었습니다. 결과보기 버튼을 클릭해주세요.');
                } else {
                    // 실패 시
                    alert(result.message || '닉네임이 중복되어 사용할 수 없습니다.');
                }
            } catch (error) {
                console.error('닉네임 저장 중 오류 발생:', error);
                alert('닉네임 저장에 실패했습니다. 다시 시도해주세요.');
            }
        });
    }

    // 자동 다음 입력창 이동 함수
    function autoNext(currentInput, maxLength, nextInputId) {
        if (currentInput.value.length >= maxLength) {
            document.getElementById(nextInputId).focus();
        }
    }
</script>
</body>
</html>